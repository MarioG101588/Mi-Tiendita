import { collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
import { db } from "./Conexion.js";
import { wrappedGetDocs, wrappedSetDoc, wrappedDeleteDoc} from "./FirebaseWrapper.js";

// Asegúrate de incluir SheetJS en tu HTML: <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

async function exportarInventarioAExcel() {
    const inventarioRef = collection(db, "inventario");
    const snapshot = await wrappedGetDocs(inventarioRef);
    const data = [];
    snapshot.forEach(doc => {
        const d = doc.data();
        data.push({
            Producto: doc.id,
            Cantidad: d.cantidad,
            PrecioVenta: d.precioVenta,
            FechaVencimiento: d.fechaVencimiento || ""
        });
    });
    // Generar hoja y archivo Excel
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    XLSX.writeFile(wb, "inventario.xlsx");
}

async function importarInventarioDesdeExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const productos = XLSX.utils.sheet_to_json(sheet);

        // 1. Leer todos los productos actuales de Firestore
        const inventarioRef = collection(db, "inventario");
        const snapshot = await wrappedGetDocs(inventarioRef);
        const productosFirestore = {};
        snapshot.forEach(docSnap => {
            productosFirestore[docSnap.id] = true;
        });

        // 2. Leer productos del Excel y construir un set de nombres
        const productosExcel = new Set();
        for (const prod of productos) {
            productosExcel.add(prod.Producto);
            // Actualizar o crear producto
            const docRef = doc(db, "inventario", prod.Producto);
            await wrappedSetDoc(docRef, {
                cantidad: Number(prod.Cantidad) || 0,
                precioVenta: Number(prod.PrecioVenta) || 0,
                fechaVencimiento: prod.FechaVencimiento || ""
            }, { merge: true });
        }

        // 3. Eliminar productos que están en Firestore pero no en el Excel
        for (const id in productosFirestore) {
            if (!productosExcel.has(id)) {
                await wrappedDeleteDoc(doc(db, "inventario", id));
            }
        }

        alert("Inventario actualizado correctamente.");
    };
    reader.readAsArrayBuffer(file);
}

// Exponer funciones globales para el HTML
window.exportarInventarioAExcel = exportarInventarioAExcel;
window.importarInventarioDesdeExcel = importarInventarioDesdeExcel;